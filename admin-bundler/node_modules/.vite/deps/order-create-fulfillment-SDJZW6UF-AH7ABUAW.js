import {
  getFulfillableQuantity
} from "./chunk-5DBAZ7R2.js";
import {
  Thumbnail
} from "./chunk-XKOLLBFA.js";
import {
  RouteFocusModal,
  useRouteModal
} from "./chunk-3P6F4Q7W.js";
import {
  useStockLocations
} from "./chunk-VN2HND4I.js";
import {
  useCreateOrderFulfillment,
  useOrder
} from "./chunk-ACJP53PC.js";
import {
  useProductVariant
} from "./chunk-3VJMO5NN.js";
import "./chunk-IH74SCJ5.js";
import "./chunk-4UMAAWOP.js";
import "./chunk-Y5OEN2X7.js";
import {
  t
} from "./chunk-NMISSY3S.js";
import {
  z
} from "./chunk-D6YTPD33.js";
import {
  Form,
  useForm,
  useWatch
} from "./chunk-TKBVWLOU.js";
import "./chunk-QDFILGGU.js";
import "./chunk-ZSXFNTF6.js";
import {
  Alert,
  Button,
  Input,
  Select,
  Switch,
  Text,
  toast,
  useTranslation
} from "./chunk-ZUPX4YFG.js";
import {
  useParams,
  useSearchParams
} from "./chunk-HTGWU6KF.js";
import "./chunk-64MXM5QD.js";
import "./chunk-3VI6QF3M.js";
import {
  require_jsx_runtime
} from "./chunk-P6CFP5BP.js";
import {
  __toESM,
  require_react
} from "./chunk-H5NG3XTT.js";

// node_modules/@medusajs/dashboard/dist/order-create-fulfillment-SDJZW6UF.mjs
var import_react = __toESM(require_react(), 1);
var import_react2 = __toESM(require_react(), 1);
var import_jsx_runtime = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime2 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime3 = __toESM(require_jsx_runtime(), 1);
var CreateFulfillmentSchema = z.object({
  quantity: z.record(z.string(), z.number()),
  location_id: z.string(),
  shipping_option_id: z.string().optional(),
  send_notification: z.boolean().optional()
});
function OrderCreateFulfillmentItem({
  item,
  form,
  locationId
}) {
  var _a, _b;
  const { t: t2 } = useTranslation();
  const { variant } = useProductVariant(
    item.variant.product_id,
    item.variant_id,
    {
      fields: "*inventory,*inventory.location_levels"
    }
  );
  const { availableQuantity, inStockQuantity } = (0, import_react2.useMemo)(() => {
    var _a2, _b2;
    if (!variant || !locationId) {
      return {};
    }
    const { inventory } = variant;
    const locationInventory = (_b2 = (_a2 = inventory[0]) == null ? void 0 : _a2.location_levels) == null ? void 0 : _b2.find(
      (inv) => inv.location_id === locationId
    );
    if (!locationInventory) {
      return {};
    }
    return {
      availableQuantity: locationInventory.available_quantity,
      inStockQuantity: locationInventory.stocked_quantity
    };
  }, [variant, locationId]);
  const minValue = 0;
  const maxValue = Math.min(
    getFulfillableQuantity(item),
    availableQuantity || Number.MAX_SAFE_INTEGER
  );
  return (0, import_jsx_runtime.jsx)("div", { className: "bg-ui-bg-subtle shadow-elevation-card-rest my-2 rounded-xl ", children: (0, import_jsx_runtime.jsxs)("div", { className: "flex flex-col gap-x-2 gap-y-2 border-b p-3 text-sm sm:flex-row", children: [
    (0, import_jsx_runtime.jsxs)("div", { className: "flex flex-1 items-center gap-x-3", children: [
      (0, import_jsx_runtime.jsx)(Thumbnail, { src: item.thumbnail }),
      (0, import_jsx_runtime.jsxs)("div", { className: "flex flex-col", children: [
        (0, import_jsx_runtime.jsxs)("div", { children: [
          (0, import_jsx_runtime.jsx)(Text, { className: "txt-small", as: "span", weight: "plus", children: item.title }),
          ((_a = item.variant) == null ? void 0 : _a.sku) && (0, import_jsx_runtime.jsxs)("span", { children: [
            "(",
            item.variant.sku,
            ")"
          ] })
        ] }),
        (0, import_jsx_runtime.jsx)(Text, { as: "div", className: "text-ui-fg-subtle txt-small", children: ((_b = item.variant) == null ? void 0 : _b.title) ?? "" })
      ] })
    ] }),
    (0, import_jsx_runtime.jsxs)("div", { className: "flex flex-1 items-center gap-x-1", children: [
      (0, import_jsx_runtime.jsx)("div", { className: "mr-2 block h-[16px] w-[2px] bg-gray-200" }),
      (0, import_jsx_runtime.jsxs)("div", { className: "text-small flex flex-1 flex-col", children: [
        (0, import_jsx_runtime.jsx)("span", { className: "text-ui-fg-subtle font-medium", children: t2("orders.fulfillment.available") }),
        (0, import_jsx_runtime.jsx)("span", { className: "text-ui-fg-subtle", children: availableQuantity || "N/A" })
      ] }),
      (0, import_jsx_runtime.jsxs)("div", { className: "flex flex-1 items-center gap-x-1", children: [
        (0, import_jsx_runtime.jsx)("div", { className: "mr-2 block h-[16px] w-[2px] bg-gray-200" }),
        (0, import_jsx_runtime.jsxs)("div", { className: "flex flex-col", children: [
          (0, import_jsx_runtime.jsx)("span", { className: "text-ui-fg-subtle font-medium", children: t2("orders.fulfillment.inStock") }),
          (0, import_jsx_runtime.jsxs)("span", { className: "text-ui-fg-subtle", children: [
            inStockQuantity || "N/A",
            " ",
            inStockQuantity && (0, import_jsx_runtime.jsxs)("span", { className: "font-medium text-red-500", children: [
              "-",
              form.getValues(`quantity.${item.id}`)
            ] })
          ] })
        ] })
      ] }),
      (0, import_jsx_runtime.jsxs)("div", { className: "flex flex-1 items-center gap-1", children: [
        (0, import_jsx_runtime.jsx)(
          Form.Field,
          {
            control: form.control,
            name: `quantity.${item.id}`,
            rules: { required: true, min: minValue, max: maxValue },
            render: ({ field }) => {
              return (0, import_jsx_runtime.jsxs)(Form.Item, { children: [
                (0, import_jsx_runtime.jsx)(Form.Control, { children: (0, import_jsx_runtime.jsx)(
                  Input,
                  {
                    className: "bg-ui-bg-base txt-small w-[50px] rounded-lg text-right [appearance:textfield] [&::-webkit-inner-spin-button]:appearance-none [&::-webkit-outer-spin-button]:appearance-none",
                    type: "number",
                    ...field,
                    onChange: (e) => {
                      const val = e.target.value === "" ? null : Number(e.target.value);
                      field.onChange(val);
                      if (!isNaN(val)) {
                        if (val < minValue || val > maxValue) {
                          form.setError(`quantity.${item.id}`, {
                            type: "manual",
                            message: t2(
                              "orders.fulfillment.error.wrongQuantity",
                              {
                                count: maxValue,
                                number: maxValue
                              }
                            )
                          });
                        } else {
                          form.clearErrors(`quantity.${item.id}`);
                        }
                      }
                    }
                  }
                ) }),
                (0, import_jsx_runtime.jsx)(Form.ErrorMessage, {})
              ] });
            }
          }
        ),
        (0, import_jsx_runtime.jsxs)("span", { className: "text-ui-fg-subtle", children: [
          "/ ",
          item.quantity,
          " ",
          t2("fields.qty")
        ] })
      ] })
    ] })
  ] }) });
}
function OrderCreateFulfillmentForm({
  order,
  requiresShipping
}) {
  const { t: t2 } = useTranslation();
  const { handleSuccess } = useRouteModal();
  const [searchParams] = useSearchParams();
  const { mutateAsync: createOrderFulfillment, isPending: isMutating } = useCreateOrderFulfillment(order.id);
  const [fulfillableItems, setFulfillableItems] = (0, import_react.useState)(
    () => (order.items || []).filter(
      (item) => item.requires_shipping === requiresShipping && getFulfillableQuantity(item) > 0
    )
  );
  const form = useForm({
    defaultValues: {
      quantity: fulfillableItems.reduce(
        (acc, item) => {
          acc[item.id] = getFulfillableQuantity(item);
          return acc;
        },
        {}
      ),
      send_notification: !order.no_notification
    },
    resolver: t(CreateFulfillmentSchema)
  });
  const { stock_locations = [] } = useStockLocations();
  const handleSubmit = form.handleSubmit(async (data) => {
    try {
      await createOrderFulfillment({
        location_id: data.location_id,
        // shipping_option_id: data.shipping_option_id,
        no_notification: !data.send_notification,
        items: Object.entries(data.quantity).filter(([, value]) => !!value).map(([id, quantity]) => ({
          id,
          quantity
        }))
      });
      toast.success(t2("orders.fulfillment.toast.created"));
      handleSuccess(`/orders/${order.id}`);
    } catch (e) {
      toast.error(e.message);
    }
  });
  (0, import_react.useEffect)(() => {
    if (stock_locations == null ? void 0 : stock_locations.length) {
      form.setValue("location_id", stock_locations[0].id);
    }
  }, [stock_locations == null ? void 0 : stock_locations.length]);
  const selectedLocationId = useWatch({
    name: "location_id",
    control: form.control
  });
  const fulfilledQuantityArray = (order.items || []).map(
    (item) => item.requires_shipping === requiresShipping && item.detail.fulfilled_quantity
  );
  (0, import_react.useEffect)(() => {
    var _a;
    const itemsToFulfill = ((_a = order == null ? void 0 : order.items) == null ? void 0 : _a.filter(
      (item) => item.requires_shipping === requiresShipping && getFulfillableQuantity(item) > 0
    )) || [];
    setFulfillableItems(itemsToFulfill);
    if (itemsToFulfill.length) {
      form.clearErrors("root");
    } else {
      form.setError("root", {
        type: "manual",
        message: t2("orders.fulfillment.error.noItems")
      });
    }
    const quantityMap = itemsToFulfill.reduce(
      (acc, item) => {
        acc[item.id] = getFulfillableQuantity(item);
        return acc;
      },
      {}
    );
    form.setValue("quantity", quantityMap);
  }, [...fulfilledQuantityArray, requiresShipping]);
  return (0, import_jsx_runtime2.jsx)(RouteFocusModal.Form, { form, children: (0, import_jsx_runtime2.jsxs)(
    "form",
    {
      onSubmit: handleSubmit,
      className: "flex h-full flex-col overflow-hidden",
      children: [
        (0, import_jsx_runtime2.jsx)(RouteFocusModal.Header, { children: (0, import_jsx_runtime2.jsxs)("div", { className: "flex items-center justify-end gap-x-2", children: [
          (0, import_jsx_runtime2.jsx)(RouteFocusModal.Close, { asChild: true, children: (0, import_jsx_runtime2.jsx)(Button, { size: "small", variant: "secondary", children: t2("actions.cancel") }) }),
          (0, import_jsx_runtime2.jsx)(Button, { size: "small", type: "submit", isLoading: isMutating, children: t2("orders.fulfillment.create") })
        ] }) }),
        (0, import_jsx_runtime2.jsx)(RouteFocusModal.Body, { className: "flex h-full w-full flex-col items-center divide-y overflow-y-auto", children: (0, import_jsx_runtime2.jsx)("div", { className: "flex size-full flex-col items-center overflow-auto p-16", children: (0, import_jsx_runtime2.jsx)("div", { className: "flex w-full max-w-[736px] flex-col justify-center px-2 pb-2", children: (0, import_jsx_runtime2.jsxs)("div", { className: "flex flex-col divide-y divide-dashed", children: [
          (0, import_jsx_runtime2.jsx)("div", { className: "pb-8", children: (0, import_jsx_runtime2.jsx)(
            Form.Field,
            {
              control: form.control,
              name: "location_id",
              render: ({ field: { onChange, ref, ...field } }) => {
                return (0, import_jsx_runtime2.jsxs)(Form.Item, { children: [
                  (0, import_jsx_runtime2.jsxs)("div", { className: "flex flex-col gap-2 xl:flex-row xl:items-center", children: [
                    (0, import_jsx_runtime2.jsxs)("div", { className: "flex-1", children: [
                      (0, import_jsx_runtime2.jsx)(Form.Label, { children: t2("fields.location") }),
                      (0, import_jsx_runtime2.jsx)(Form.Hint, { children: t2("orders.fulfillment.locationDescription") })
                    ] }),
                    (0, import_jsx_runtime2.jsx)("div", { className: "flex-1", children: (0, import_jsx_runtime2.jsx)(Form.Control, { children: (0, import_jsx_runtime2.jsxs)(Select, { onValueChange: onChange, ...field, children: [
                      (0, import_jsx_runtime2.jsx)(
                        Select.Trigger,
                        {
                          className: "bg-ui-bg-base",
                          ref,
                          children: (0, import_jsx_runtime2.jsx)(Select.Value, {})
                        }
                      ),
                      (0, import_jsx_runtime2.jsx)(Select.Content, { children: stock_locations.map((l) => (0, import_jsx_runtime2.jsx)(Select.Item, { value: l.id, children: l.name }, l.id)) })
                    ] }) }) })
                  ] }),
                  (0, import_jsx_runtime2.jsx)(Form.ErrorMessage, {})
                ] });
              }
            }
          ) }),
          (0, import_jsx_runtime2.jsxs)("div", { children: [
            (0, import_jsx_runtime2.jsxs)(Form.Item, { className: "mt-8", children: [
              (0, import_jsx_runtime2.jsx)(Form.Label, { children: t2("orders.fulfillment.itemsToFulfill") }),
              (0, import_jsx_runtime2.jsx)(Form.Hint, { children: t2("orders.fulfillment.itemsToFulfillDesc") }),
              (0, import_jsx_runtime2.jsx)("div", { className: "flex flex-col gap-y-1", children: fulfillableItems.map((item) => {
                return (0, import_jsx_runtime2.jsx)(
                  OrderCreateFulfillmentItem,
                  {
                    form,
                    item,
                    locationId: selectedLocationId
                  },
                  item.id
                );
              }) })
            ] }),
            form.formState.errors.root && (0, import_jsx_runtime2.jsx)(
              Alert,
              {
                variant: "error",
                dismissible: false,
                className: "flex items-center",
                classNameInner: "flex justify-between flex-1 items-center",
                children: form.formState.errors.root.message
              }
            )
          ] }),
          (0, import_jsx_runtime2.jsx)("div", { className: "mt-8 pt-8 ", children: (0, import_jsx_runtime2.jsx)(
            Form.Field,
            {
              control: form.control,
              name: "send_notification",
              render: ({ field: { onChange, value, ...field } }) => {
                return (0, import_jsx_runtime2.jsxs)(Form.Item, { children: [
                  (0, import_jsx_runtime2.jsxs)("div", { className: "flex items-center justify-between", children: [
                    (0, import_jsx_runtime2.jsx)(Form.Label, { children: t2("orders.returns.sendNotification") }),
                    (0, import_jsx_runtime2.jsx)(Form.Control, { children: (0, import_jsx_runtime2.jsx)(Form.Control, { children: (0, import_jsx_runtime2.jsx)(
                      Switch,
                      {
                        checked: !!value,
                        onCheckedChange: onChange,
                        ...field
                      }
                    ) }) })
                  ] }),
                  (0, import_jsx_runtime2.jsx)(Form.Hint, { className: "!mt-1", children: t2("orders.fulfillment.sendNotificationHint") }),
                  (0, import_jsx_runtime2.jsx)(Form.ErrorMessage, {})
                ] });
              }
            }
          ) })
        ] }) }) }) })
      ]
    }
  ) });
}
function OrderCreateFulfillment() {
  const { id } = useParams();
  const [searchParams] = useSearchParams();
  const requiresShipping = searchParams.get("requires_shipping") === "true";
  const { order, isLoading, isError, error } = useOrder(id, {
    fields: "currency_code,*items,*items.variant,*shipping_address"
  });
  if (isError) {
    throw error;
  }
  const ready = !isLoading && order;
  return (0, import_jsx_runtime3.jsx)(RouteFocusModal, { children: ready && (0, import_jsx_runtime3.jsx)(
    OrderCreateFulfillmentForm,
    {
      order,
      requiresShipping
    }
  ) });
}
export {
  OrderCreateFulfillment as Component
};
//# sourceMappingURL=order-create-fulfillment-SDJZW6UF-AH7ABUAW.js.map
