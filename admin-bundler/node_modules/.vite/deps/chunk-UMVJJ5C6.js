import {
  formatCurrency
} from "./chunk-UTJBGVIO.js";
import {
  getOrderPaymentStatus
} from "./chunk-CIFTBZLQ.js";
import {
  getLocaleAmount,
  getStylizedAmount
} from "./chunk-MWKZ5MLM.js";
import {
  useCapturePayment
} from "./chunk-ENW5Z6NU.js";
import {
  ActionMenu
} from "./chunk-IE22HJTV.js";
import {
  format
} from "./chunk-3FGSU2DA.js";
import {
  ArrowDownRightMini,
  Badge,
  Button,
  Container,
  DocumentText,
  Heading,
  StatusBadge,
  Text,
  Tooltip,
  XCircle,
  toast,
  usePrompt,
  useTranslation
} from "./chunk-ZUPX4YFG.js";
import {
  require_jsx_runtime
} from "./chunk-P6CFP5BP.js";
import {
  __toESM
} from "./chunk-H5NG3XTT.js";

// node_modules/@medusajs/dashboard/dist/chunk-Z4SZR3MN.mjs
var import_jsx_runtime = __toESM(require_jsx_runtime(), 1);
var getTotalCaptured = (paymentCollections) => paymentCollections.reduce((acc, paymentCollection) => {
  acc = acc + (paymentCollection.captured_amount - paymentCollection.refunded_amount);
  return acc;
}, 0);
var getTotalPending = (paymentCollections) => paymentCollections.reduce((acc, paymentCollection) => {
  acc += paymentCollection.amount - paymentCollection.captured_amount;
  return acc;
}, 0);
var getPaymentsFromOrder = (order) => {
  return order.payment_collections.map((collection) => collection.payments).flat(1).filter(Boolean);
};
var OrderPaymentSection = ({ order }) => {
  const payments = getPaymentsFromOrder(order);
  const refunds = payments.map((payment) => payment == null ? void 0 : payment.refunds).flat(1).filter(Boolean);
  return (0, import_jsx_runtime.jsxs)(Container, { className: "divide-y divide-dashed p-0", children: [
    (0, import_jsx_runtime.jsx)(Header, { order }),
    (0, import_jsx_runtime.jsx)(
      PaymentBreakdown,
      {
        order,
        payments,
        refunds,
        currencyCode: order.currency_code
      }
    ),
    (0, import_jsx_runtime.jsx)(
      Total,
      {
        paymentCollections: order.payment_collections,
        currencyCode: order.currency_code
      }
    )
  ] });
};
var Header = ({ order }) => {
  const { t } = useTranslation();
  const { label, color } = getOrderPaymentStatus(t, order.payment_status);
  return (0, import_jsx_runtime.jsxs)("div", { className: "flex items-center justify-between px-6 py-4", children: [
    (0, import_jsx_runtime.jsx)(Heading, { level: "h2", children: t("orders.payment.title") }),
    (0, import_jsx_runtime.jsx)(StatusBadge, { color, className: "text-nowrap", children: label })
  ] });
};
var Refund = ({
  refund,
  currencyCode
}) => {
  const { t } = useTranslation();
  const RefundReasonBadge = (refund == null ? void 0 : refund.refund_reason) && (0, import_jsx_runtime.jsx)(
    Badge,
    {
      size: "2xsmall",
      className: "cursor-default select-none capitalize",
      rounded: "full",
      children: refund.refund_reason.label
    }
  );
  const RefundNoteIndicator = refund.note && (0, import_jsx_runtime.jsx)(Tooltip, { content: refund.note, children: (0, import_jsx_runtime.jsx)(DocumentText, { className: "text-ui-tag-neutral-icon ml-1 inline" }) });
  return (0, import_jsx_runtime.jsxs)("div", { className: "bg-ui-bg-subtle text-ui-fg-subtle grid grid-cols-[1fr_1fr_1fr_20px] items-center gap-x-4 px-6 py-4", children: [
    (0, import_jsx_runtime.jsxs)("div", { className: "flex flex-row", children: [
      (0, import_jsx_runtime.jsx)("div", { className: "self-center pr-3", children: (0, import_jsx_runtime.jsx)(ArrowDownRightMini, { className: "text-ui-fg-muted" }) }),
      (0, import_jsx_runtime.jsxs)("div", { children: [
        (0, import_jsx_runtime.jsxs)(Text, { size: "small", leading: "compact", weight: "plus", children: [
          t("orders.payment.refund"),
          " ",
          RefundNoteIndicator
        ] }),
        (0, import_jsx_runtime.jsx)(Text, { size: "small", leading: "compact", children: format(new Date(refund.created_at), "dd MMM, yyyy, HH:mm:ss") })
      ] })
    ] }),
    (0, import_jsx_runtime.jsx)("div", { className: "flex items-center justify-end", children: RefundReasonBadge }),
    (0, import_jsx_runtime.jsx)("div", { className: "flex items-center justify-end", children: (0, import_jsx_runtime.jsxs)(Text, { size: "small", leading: "compact", children: [
      "- ",
      getLocaleAmount(refund.amount, currencyCode)
    ] }) })
  ] });
};
var Payment = ({
  order,
  payment,
  refunds,
  currencyCode
}) => {
  const { t } = useTranslation();
  const prompt = usePrompt();
  const { mutateAsync } = useCapturePayment(order.id, payment.id);
  const handleCapture = async () => {
    const res = await prompt({
      title: t("orders.payment.capture"),
      description: t("orders.payment.capturePayment", {
        amount: formatCurrency(payment.amount, currencyCode)
      }),
      confirmText: t("actions.confirm"),
      cancelText: t("actions.cancel"),
      variant: "confirmation"
    });
    if (!res) {
      return;
    }
    await mutateAsync(
      { amount: payment.amount },
      {
        onSuccess: () => {
          toast.success(
            t("orders.payment.capturePaymentSuccess", {
              amount: formatCurrency(payment.amount, currencyCode)
            })
          );
        },
        onError: (error) => {
          toast.error(error.message);
        }
      }
    );
  };
  const [status, color] = payment.captured_at ? ["Captured", "green"] : ["Pending", "orange"];
  const cleanId = payment.id.replace("pay_", "");
  const showCapture = payment.captured_at === null && payment.canceled_at === null;
  return (0, import_jsx_runtime.jsxs)("div", { className: "divide-y divide-dashed", children: [
    (0, import_jsx_runtime.jsxs)("div", { className: "text-ui-fg-subtle grid grid-cols-[1fr_1fr_1fr_1fr_20px] items-center gap-x-4 px-6 py-4", children: [
      (0, import_jsx_runtime.jsxs)("div", { className: "w-full overflow-hidden", children: [
        (0, import_jsx_runtime.jsx)(
          Text,
          {
            size: "small",
            leading: "compact",
            weight: "plus",
            className: "truncate",
            children: cleanId
          }
        ),
        (0, import_jsx_runtime.jsx)(Text, { size: "small", leading: "compact", children: format(
          new Date(payment.created_at),
          "dd MMM, yyyy, HH:mm:ss"
        ) })
      ] }),
      (0, import_jsx_runtime.jsx)("div", { className: "flex items-center justify-end", children: (0, import_jsx_runtime.jsx)(Text, { size: "small", leading: "compact", className: "capitalize", children: payment.provider_id }) }),
      (0, import_jsx_runtime.jsx)("div", { className: "flex items-center justify-end", children: (0, import_jsx_runtime.jsx)(StatusBadge, { color, className: "text-nowrap", children: status }) }),
      (0, import_jsx_runtime.jsx)("div", { className: "flex items-center justify-end", children: (0, import_jsx_runtime.jsx)(Text, { size: "small", leading: "compact", children: getLocaleAmount(payment.amount, payment.currency_code) }) }),
      (0, import_jsx_runtime.jsx)(
        ActionMenu,
        {
          groups: [
            {
              actions: [
                {
                  label: t("orders.payment.refund"),
                  icon: (0, import_jsx_runtime.jsx)(XCircle, {}),
                  to: `/orders/${order.id}/refund?paymentId=${payment.id}`,
                  disabled: !payment.captured_at
                }
              ]
            }
          ]
        }
      )
    ] }),
    showCapture && (0, import_jsx_runtime.jsxs)("div", { className: "bg-ui-bg-subtle flex items-center justify-between px-6 py-4", children: [
      (0, import_jsx_runtime.jsxs)("div", { className: "flex items-center gap-x-2", children: [
        (0, import_jsx_runtime.jsx)(ArrowDownRightMini, { className: "text-ui-fg-muted" }),
        (0, import_jsx_runtime.jsx)(Text, { size: "small", leading: "compact", children: t("orders.payment.isReadyToBeCaptured", {
          id: cleanId
        }) })
      ] }),
      (0, import_jsx_runtime.jsx)(Button, { size: "small", variant: "secondary", onClick: handleCapture, children: t("orders.payment.capture") })
    ] }),
    refunds.map((refund) => (0, import_jsx_runtime.jsx)(Refund, { refund, currencyCode }, refund.id))
  ] });
};
var PaymentBreakdown = ({
  order,
  payments,
  refunds,
  currencyCode
}) => {
  const orderRefunds = refunds.filter((refund) => refund.payment_id === null);
  const entries = [...orderRefunds, ...payments].sort((a, b) => {
    return new Date(a.created_at).getTime() - new Date(b.created_at).getTime();
  }).map((entry) => {
    return {
      event: entry,
      type: entry.id.startsWith("pay_") ? "payment" : "refund"
    };
  });
  return (0, import_jsx_runtime.jsx)("div", { className: "flex flex-col divide-y divide-dashed", children: entries.map(({ type, event }) => {
    switch (type) {
      case "payment":
        return (0, import_jsx_runtime.jsx)(
          Payment,
          {
            order,
            payment: event,
            refunds: refunds.filter(
              (refund) => refund.payment_id === event.id
            ),
            currencyCode
          },
          event.id
        );
      case "refund":
        return (0, import_jsx_runtime.jsx)(
          Refund,
          {
            refund: event,
            currencyCode
          },
          event.id
        );
    }
  }) });
};
var Total = ({
  paymentCollections,
  currencyCode
}) => {
  const { t } = useTranslation();
  const totalPending = getTotalPending(paymentCollections);
  return (0, import_jsx_runtime.jsxs)("div", { children: [
    (0, import_jsx_runtime.jsxs)("div", { className: "flex items-center justify-between px-6 py-4", children: [
      (0, import_jsx_runtime.jsx)(Text, { size: "small", weight: "plus", leading: "compact", children: t("orders.payment.totalPaidByCustomer") }),
      (0, import_jsx_runtime.jsx)(Text, { size: "small", weight: "plus", leading: "compact", children: getStylizedAmount(
        getTotalCaptured(paymentCollections),
        currencyCode
      ) })
    ] }),
    totalPending > 0 && (0, import_jsx_runtime.jsxs)("div", { className: "flex items-center justify-between px-6 py-4", children: [
      (0, import_jsx_runtime.jsx)(Text, { size: "small", weight: "plus", leading: "compact", children: "Total pending" }),
      (0, import_jsx_runtime.jsx)(Text, { size: "small", weight: "plus", leading: "compact", children: getStylizedAmount(totalPending, currencyCode) })
    ] })
  ] });
};

export {
  getTotalCaptured,
  getPaymentsFromOrder,
  OrderPaymentSection
};
//# sourceMappingURL=chunk-UMVJJ5C6.js.map
